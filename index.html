<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TARKIB LEGEND - SDIT Qurratu A'yun</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #ecfdf5; 
            touch-action: none; 
            overflow: hidden;
            user-select: none; 
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        .arabic-text {
            font-family: 'Amiri', serif;
            line-height: 1.8;
        }
        button {
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .pop-in { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .pulse-red { animation: pulseRed 1s infinite; }
        @keyframes pulseRed {
            0% { color: #ef4444; }
            50% { color: #7f1d1d; }
            100% { color: #ef4444; }
        }
        .bg-pattern {
            background-image: radial-gradient(#10b981 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.1;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <div id="root"></div>

    <script type="text/babel">
        // --- SOUND ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        const playTone = (freq, type, duration, delay = 0) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(audioCtx.currentTime + delay);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime + delay);
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + delay + duration);
            osc.stop(audioCtx.currentTime + delay + duration);
        };

        const playCorrectSound = () => { playTone(600, 'sine', 0.1); playTone(800, 'sine', 0.2, 0.1); };
        const playWrongSound = () => { playTone(150, 'sawtooth', 0.3); };
        const playLevelCompleteSound = () => { playTone(400, 'triangle', 0.1); playTone(500, 'triangle', 0.1, 0.1); playTone(600, 'triangle', 0.1, 0.2); playTone(800, 'triangle', 0.4, 0.3); };
        const playGrandFanfare = () => { [523, 659, 783, 1046, 783, 1046].forEach((freq, i) => { playTone(freq, 'square', 0.2, i * 0.15); }); };

        // --- VISUAL EFFECTS ---
        const fireConfetti = (intensity = 1) => {
            if (typeof confetti === 'undefined') return;
            if (intensity === 1) {
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            } else {
                var duration = 3000; var end = Date.now() + duration;
                (function frame() {
                    confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                    confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                    if (Date.now() < end) requestAnimationFrame(frame);
                }());
            }
        };

        // --- DATA SOAL MASSIVE (ULTIMATE) ---
        const gameDataDatabase = [
            // =================================================================
            // LEVEL 1A: FRASA JAR MAJRUR & ZHARAF (100+ Soal)
            // =================================================================
            // Sekolah & Kelas
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di dalam kelas", correctWords: ["فِي", "الْفَصْلِ"], distractors: ["عَلَى", "فَصْلٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di atas meja", correctWords: ["عَلَى", "الْمَكْتَبِ"], distractors: ["فِي", "مَكْتَبٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di dalam tas", correctWords: ["فِي", "الْحَقِيبَةِ"], distractors: ["عَلَى", "حَقِيبَةٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di atas kursi", correctWords: ["عَلَى", "الْكُرْسِيِّ"], distractors: ["تَحْتَ", "كُرْسِيٌّ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Ke sekolah", correctWords: ["إِلَى", "الْمَدْرَسَةِ"], distractors: ["مِنَ", "مَدْرَسَةٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Dari perpustakaan", correctWords: ["مِنَ", "الْمَكْتَبَةِ"], distractors: ["إِلَى", "مَكْتَبَةٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di laboratorium", correctWords: ["فِي", "الْمَعْمَلِ"], distractors: ["عَلَى", "مَعْمَلٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Ke kantin", correctWords: ["إِلَى", "الْمَقْصَفِ"], distractors: ["مِنَ", "مَقْصَفٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di halaman", correctWords: ["فِي", "السَّاحَةِ"], distractors: ["عَلَى", "سَاحَةٌ"] },
            
            // Rumah & Perabot
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di dalam rumah", correctWords: ["فِي", "الْبَيْتِ"], distractors: ["عَلَى", "بَيْتٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di atas ranjang", correctWords: ["عَلَى", "السَّرِيرِ"], distractors: ["فِي", "سَرِيرٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di dalam lemari", correctWords: ["فِي", "الْخِزَانَةِ"], distractors: ["عَلَى", "خِزَانَةٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di dapur", correctWords: ["فِي", "الْمَطْبَخِ"], distractors: ["عَلَى", "مَطْبَخٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di kamar mandi", correctWords: ["فِي", "الْحَمَّامِ"], distractors: ["عَلَى", "حَمَّامٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di atas lantai", correctWords: ["عَلَى", "الْبِلَاطِ"], distractors: ["فِي", "بِلَاطٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di atas dinding", correctWords: ["عَلَى", "الْجِدَارِ"], distractors: ["فِي", "جِدَارٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di atas atap", correctWords: ["عَلَى", "السَّقْفِ"], distractors: ["فِي", "سَقْفٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di dalam wajan", correctWords: ["فِي", "الْمِقْلَاةِ"], distractors: ["عَلَى", "مِقْلَاةٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di atas piring", correctWords: ["عَلَى", "الصَّحْنِ"], distractors: ["فِي", "صَحْنٌ"] },
            
            // Tempat Umum
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Ke masjid", correctWords: ["إِلَى", "الْمَسْجِدِ"], distractors: ["مِنَ", "مَسْجِدٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Dari pasar", correctWords: ["مِنَ", "السُّوقِ"], distractors: ["إِلَى", "سُوقٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Ke rumah sakit", correctWords: ["إِلَى", "الْمُسْتَشْفَى"], distractors: ["مِنَ", "مُسْتَشْفَى"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Dari bandara", correctWords: ["مِنَ", "الْمَطَارِ"], distractors: ["إِلَى", "مَطَارٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Ke pelabuhan", correctWords: ["إِلَى", "الْمِينَاءِ"], distractors: ["مِنَ", "مِينَاءٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di hotel", correctWords: ["فِي", "الْفُنْدُقِ"], distractors: ["عَلَى", "فُنْدُقٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur", indonesian: "Di restoran", correctWords: ["فِي", "الْمَطْعَمِ"], distractors: ["عَلَى", "مَطْعَمٌ"] },

            // Huruf Jar Lainnya
            { level: 1.1, category: "L1A: Jar Majrur (Bi)", indonesian: "Dengan pena", correctWords: ["بِالْقَلَمِ"], distractors: ["بِ", "قَلَمٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur (Bi)", indonesian: "Dengan mobil", correctWords: ["بِالسَّيَّارَةِ"], distractors: ["بِ", "سَيَّارَةٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur (Bi)", indonesian: "Dengan sendok", correctWords: ["بِالْمِلْعَقَةِ"], distractors: ["بِ", "مِلْعَقَةٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur (Li)", indonesian: "Milik Allah", correctWords: ["لِلَّهِ"], distractors: ["لِ", "اللهِ"] },
            { level: 1.1, category: "L1A: Jar Majrur (Li)", indonesian: "Untuk guru (lk)", correctWords: ["لِلْمُدَرِّسِ"], distractors: ["لِ", "مُدَرِّسٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur (Li)", indonesian: "Untuk siswa (lk)", correctWords: ["لِلطَّالِبِ"], distractors: ["لِ", "طَالِبٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur (Ka)", indonesian: "Seperti bulan", correctWords: ["كَالْقَمَرِ"], distractors: ["كَ", "قَمَرٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur (Ka)", indonesian: "Seperti singa", correctWords: ["كَالْأَسَدِ"], distractors: ["كَ", "أَسَدٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur ('An)", indonesian: "Tentang pelajaran", correctWords: ["عَنِ", "الدَّرْسِ"], distractors: ["فِي", "دَرْسٌ"] },
            { level: 1.1, category: "L1A: Jar Majrur ('An)", indonesian: "Tentang nabi", correctWords: ["عَنِ", "النَّبِيِّ"], distractors: ["فِي", "نَبِيٌّ"] },

            // Zharaf (Keterangan Tempat)
            { level: 1.1, category: "L1A: Zharaf", indonesian: "Di depan sekolah", correctWords: ["أَمَامَ", "الْمَدْرَسَةِ"], distractors: ["وَرَاءَ", "مَدْرَسَةٌ"] },
            { level: 1.1, category: "L1A: Zharaf", indonesian: "Di belakang rumah", correctWords: ["وَرَاءَ", "الْبَيْتِ"], distractors: ["أَمَامَ", "بَيْتٌ"] },
            { level: 1.1, category: "L1A: Zharaf", indonesian: "Di samping toko", correctWords: ["جَانِبَ", "الدُّكَّانِ"], distractors: ["أَمَامَ", "دُكَّانٌ"] },
            { level: 1.1, category: "L1A: Zharaf", indonesian: "Di bawah meja", correctWords: ["تَحْتَ", "الْمَكْتَبِ"], distractors: ["فَوْقَ", "مَكْتَبٌ"] },
            { level: 1.1, category: "L1A: Zharaf", indonesian: "Di atas pohon", correctWords: ["فَوْقَ", "الشَّجَرَةِ"], distractors: ["تَحْتَ", "شَجَرَةٌ"] },
            { level: 1.1, category: "L1A: Zharaf", indonesian: "Di sekitar Ka'bah", correctWords: ["حَوْلَ", "الْكَعْبَةِ"], distractors: ["أَمَامَ", "كَعْبَةٌ"] },
            { level: 1.1, category: "L1A: Zharaf", indonesian: "Di sisi Allah", correctWords: ["عِنْدَ", "اللهِ"], distractors: ["مَعَ", "اللهَ"] },
            { level: 1.1, category: "L1A: Zharaf", indonesian: "Di antara dua siswa", correctWords: ["بَيْنَ", "الطَّالِبَيْنِ"], distractors: ["أَمَامَ", "طَالِبَيْنِ"] },


            // =================================================================
            // LEVEL 1B: FRASA IDHAFAH (Kepemilikan / Sandaran)
            // =================================================================
            // Umum
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Pintu masjid", correctWords: ["بَابُ", "الْمَسْجِدِ"], distractors: ["الْبَابُ", "مَسْجِدًا"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Guru (lk) sekolah", correctWords: ["مُدَرِّسُ", "الْمَدْرَسَةِ"], distractors: ["مُدَرِّسٌ", "مَدْرَسَةً"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Kepala sekolah (pr)", correctWords: ["مُدِيرَةُ", "الْمَدْرَسَةِ"], distractors: ["مُدِيرَةٌ", "مَدْرَسَةٌ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Kunci rumah", correctWords: ["مِفْتَاحُ", "الْبَيْتِ"], distractors: ["مِفْتَاحٌ", "بَيْتٌ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Buku siswa (lk)", correctWords: ["كِتَابُ", "الطَّالِبِ"], distractors: ["كِتَابٌ", "طَالِبٌ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Pena guru", correctWords: ["قَلَمُ", "الْمُدَرِّسِ"], distractors: ["قَلَمٌ", "مُدَرِّسٌ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Kaca mobil", correctWords: ["زُجَاجُ", "السَّيَّارَةِ"], distractors: ["زُجَاجٌ", "سَيَّارَةٌ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Dinding kamar", correctWords: ["جِدَارُ", "الْغُرْفَةِ"], distractors: ["جِدَارٌ", "غُرْفَةٌ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Air laut", correctWords: ["مَاءُ", "الْبَحْرِ"], distractors: ["مَاءٌ", "بَحْرٌ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Jus jeruk", correctWords: ["عَصِيرُ", "الْبُرْتُقَالِ"], distractors: ["عَصِيرٌ", "بُرْتُقَالٌ"] },
            
            // Islami
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Kitab Allah", correctWords: ["كِتَابُ", "اللهِ"], distractors: ["كِتَابٌ", "اللهَ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Utusan Allah", correctWords: ["رَسُولُ", "اللهِ"], distractors: ["رَسُولٌ", "اللهَ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Rumah Allah", correctWords: ["بَيْتُ", "اللهِ"], distractors: ["بَيْتٌ", "اللهَ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Agama Islam", correctWords: ["دِينُ", "الْإِسْلَامِ"], distractors: ["دِينٌ", "إِسْلَامًا"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Cahaya Iman", correctWords: ["نُورُ", "الْإِيمَانِ"], distractors: ["نُورٌ", "إِيمَانًا"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Siksa Kubur", correctWords: ["عَذَابُ", "الْقَبْرِ"], distractors: ["عَذَابٌ", "قَبْرًا"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Penduduk Surga", correctWords: ["أَهْلُ", "الْجَنَّةِ"], distractors: ["أَهْلٌ", "جَنَّةٌ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Hari Kiamat", correctWords: ["يَوْمُ", "الْقِيَامَةِ"], distractors: ["يَوْمٌ", "قِيَامَةٌ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Pintu surga", correctWords: ["بَابُ", "الْجَنَّةِ"], distractors: ["بَابٌ", "جَنَّةٌ"] },
            { level: 1.2, category: "L1B: Idhafah", indonesian: "Pintu neraka", correctWords: ["بَابُ", "النَّارِ"], distractors: ["بَابٌ", "نَارٌ"] },


            // =================================================================
            // LEVEL 1C: FRASA NA'AT MAN'UT (Kata Sifat)
            // =================================================================
            // Nakirah (Umum - Tanwin)
            { level: 1.3, category: "L1C: Sifat (Nakirah)", indonesian: "Sebuah tas baru", correctWords: ["حَقِيبَةٌ", "جَدِيدَةٌ"], distractors: ["الْحَقِيبَةُ", "الْجَدِيدَةُ"] },
            { level: 1.3, category: "L1C: Sifat (Nakirah)", indonesian: "Seorang murid yang rajin", correctWords: ["طَالِبٌ", "مُجْتَهِدٌ"], distractors: ["الطَّالِبُ", "الْمُجْتَهِدُ"] },
            { level: 1.3, category: "L1C: Sifat (Nakirah)", indonesian: "Sebuah pulpen lama", correctWords: ["قَلَمٌ", "قَدِيمٌ"], distractors: ["الْقَلَمُ", "جَدِيدٌ"] },
            { level: 1.3, category: "L1C: Sifat (Nakirah)", indonesian: "Seorang guru (pr) yang pandai", correctWords: ["مُدَرِّسَةٌ", "مَاهِرَةٌ"], distractors: ["مُدَرِّسٌ", "مَاهِرٌ"] },
            { level: 1.3, category: "L1C: Sifat (Nakirah)", indonesian: "Kemeja putih", correctWords: ["قَمِيصٌ", "أَبْيَضُ"], distractors: ["قَمِيصًا", "أَسْوَدُ"] },
            { level: 1.3, category: "L1C: Sifat (Nakirah)", indonesian: "Bunga yang indah", correctWords: ["زَهْرَةٌ", "جَمِيلَةٌ"], distractors: ["زَهْرَةً", "جَمِيلٌ"] },
            { level: 1.3, category: "L1C: Sifat (Nakirah)", indonesian: "Masjid yang besar", correctWords: ["مَسْجِدٌ", "كَبِيرٌ"], distractors: ["مَسْجِدًا", "كَبِيرَةٌ"] },
            { level: 1.3, category: "L1C: Sifat (Nakirah)", indonesian: "Sekolah yang bersih", correctWords: ["مَدْرَسَةٌ", "نَظِيفَةٌ"], distractors: ["مَدْرَسَةٍ", "نَظِيفٌ"] },
            { level: 1.3, category: "L1C: Sifat (Nakirah)", indonesian: "Air yang dingin", correctWords: ["مَاءٌ", "بَارِدٌ"], distractors: ["مَاءً", "حَارٌّ"] },
            { level: 1.3, category: "L1C: Sifat (Nakirah)", indonesian: "Kopi yang panas", correctWords: ["قَهْوَةٌ", "حَارَّةٌ"], distractors: ["قَهْوَةً", "بَارِدَةٌ"] },
            
            // Ma'rifah (Khusus - Alif Lam)
            { level: 1.3, category: "L1C: Sifat (Ma'rifah)", indonesian: "Peci yang hitam itu", correctWords: ["الْقَلَنْسُوَةُ", "السَّوْدَاءُ"], distractors: ["قَلَنْسُوَةٌ", "سَوْدَاءُ"] },
            { level: 1.3, category: "L1C: Sifat (Ma'rifah)", indonesian: "Kemeja yang bersih itu", correctWords: ["الْقَمِيصُ", "النَّظِيفُ"], distractors: ["قَمِيصٌ", "نَظِيفٌ"] },
            { level: 1.3, category: "L1C: Sifat (Ma'rifah)", indonesian: "Kelas yang luas itu", correctWords: ["الْفَصْلُ", "الْوَاسِعُ"], distractors: ["فَصْلٌ", "وَاسِعٌ"] },
            { level: 1.3, category: "L1C: Sifat (Ma'rifah)", indonesian: "Sekolah yang besar itu", correctWords: ["الْمَدْرَسَةُ", "الْكَبِيرَةُ"], distractors: ["مَدْرَسَةٌ", "كَبِيرَةٌ"] },
            { level: 1.3, category: "L1C: Sifat (Ma'rifah)", indonesian: "Jalan yang lurus itu", correctWords: ["الصِّرَاطُ", "الْمُسْتَقِيمُ"], distractors: ["صِرَاطٌ", "مُسْتَقِيمٌ"] },
            { level: 1.3, category: "L1C: Sifat (Ma'rifah)", indonesian: "Guru (lk) yang shalih itu", correctWords: ["الْمُدَرِّسُ", "الصَّالِحُ"], distractors: ["مُدَرِّسٌ", "صَالِحٌ"] },
            { level: 1.3, category: "L1C: Sifat (Ma'rifah)", indonesian: "Pedagang (lk) yang jujur itu", correctWords: ["التَّاجِرُ", "الْأَمِينُ"], distractors: ["تَاجِرٌ", "أَمِينٌ"] },
            { level: 1.3, category: "L1C: Sifat (Ma'rifah)", indonesian: "Rumah yang sempit itu", correctWords: ["الْبَيْتُ", "الضَّيِّقُ"], distractors: ["بَيْتٌ", "ضَيِّقٌ"] },

            // =================================================================
            // LEVEL 2: JUMLAH ISMIYAH (Mubtada + Khobar)
            // =================================================================
            // PROFESI & SIFAT
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Dokter itu mahir", correctWords: ["الطَّبِيبُ", "مَاهِرٌ"], distractors: ["مَاهِرَةٌ", "طَبِيبٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Pedagang itu kaya", correctWords: ["التَّاجِرُ", "غَنِيٌّ"], distractors: ["فَقِيرٌ", "تَاجِرٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Petani itu rajin", correctWords: ["الْفَلَّاحُ", "مُجْتَهِدٌ"], distractors: ["كَسْلَانُ", "فَلَّاحٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Guru (pr) itu sabar", correctWords: ["الْمُدَرِّسَةُ", "صَابِرَةٌ"], distractors: ["صَابِرٌ", "مُدَرِّسَةٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Polisi itu berani", correctWords: ["الشُّرْطِيُّ", "شُجَاعٌ"], distractors: ["خَائِفٌ", "شُرْطِيٌّ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Pegawai (lk) itu sibuk", correctWords: ["الْمُوَظَّفُ", "مَشْغُولٌ"], distractors: ["مَشْغُولَةٌ", "مُوَظَّفٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Insinyur itu cerdas", correctWords: ["الْمُهَنْدِسُ", "ذَكِيٌّ"], distractors: ["غَبِيٌّ", "مُهَنْدِسٌ"] },
            
            // HEWAN & SIFAT
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Gajah itu besar", correctWords: ["الْفِيلُ", "كَبِيرٌ"], distractors: ["صَغِيرٌ", "نَمْلٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Singa itu kuat", correctWords: ["الْأَسَدُ", "قَوِيٌّ"], distractors: ["ضَعِيفٌ", "أَسَدٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Semut itu lemah", correctWords: ["النَّمْلُ", "ضَعِيفٌ"], distractors: ["قَوِيٌّ", "فِيلٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Kucing itu kecil", correctWords: ["الْقِطُّ", "صَغِيرٌ"], distractors: ["كَبِيرٌ", "قِطٌّ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Kuda itu cepat", correctWords: ["الْحِصَانُ", "سَرِيعٌ"], distractors: ["بَطِيءٌ", "حِصَانٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Ayam jantan itu bagus", correctWords: ["الدِّيكُ", "جَمِيلٌ"], distractors: ["قَبِيحٌ", "دِيكٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Unta itu sabar", correctWords: ["الْجَمَلُ", "صَبُورٌ"], distractors: ["جَمَلٌ", "عَجُولٌ"] },

            // BUAH & RASA
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Apel itu manis", correctWords: ["التُّفَّاحُ", "حُلْوٌ"], distractors: ["مُرٌّ", "حَامِضٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Kopi itu pahit", correctWords: ["الْقَهْوَةُ", "مُرَّةٌ"], distractors: ["حُلْوَةٌ", "قَهْوَةٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Lemon itu masam", correctWords: ["اللَّيْمُونُ", "حَامِضٌ"], distractors: ["حُلْوٌ", "لَيْمُونٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Teh itu panas", correctWords: ["الشَّايُ", "حَارٌّ"], distractors: ["بَارِدٌ", "شَايٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Air itu dingin", correctWords: ["الْمَاءُ", "بَارِدٌ"], distractors: ["حَارٌّ", "مَاءٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Susu itu putih", correctWords: ["اللَّبَنُ", "أَبْيَضُ"], distractors: ["أَسْوَدُ", "لَبَنٌ"] },
            
            // BENDA & SIFAT
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Rumah itu luas", correctWords: ["الْبَيْتُ", "وَاسِعٌ"], distractors: ["ضَيِّقٌ", "بَيْتٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Lantai itu bersih", correctWords: ["الْبِلَاطُ", "نَظِيفٌ"], distractors: ["وَسِخٌ", "بِلَاطٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Mobil itu baru", correctWords: ["السَّيَّارَةُ", "جَدِيدَةٌ"], distractors: ["جَدِيدٌ", "سَيَّارَةٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Masjid itu jauh", correctWords: ["الْمَسْجِدُ", "بَعِيدٌ"], distractors: ["قَرِيبٌ", "مَسْجِدٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Sekolah itu dekat", correctWords: ["الْمَدْرَسَةُ", "قَرِيبَةٌ"], distractors: ["بَعِيدَةٌ", "مَدْرَسَةٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Tas itu berat", correctWords: ["الْحَقِيبَةُ", "ثَقِيلَةٌ"], distractors: ["خَفِيفَةٌ", "حَقِيبَةٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Kapas itu ringan", correctWords: ["الْقُطْنُ", "خَفِيفٌ"], distractors: ["ثَقِيلٌ", "قُطْنٌ"] },
            { level: 2, category: "L2: Khobar Mufrad", indonesian: "Jalan itu sempit", correctWords: ["الطَّرِيقُ", "ضَيِّقٌ"], distractors: ["وَاسِعٌ", "طَرِيقٌ"] },

            // SYIBHUL JUMLAH (KETERANGAN TEMPAT)
            { level: 2, category: "L2: Khobar Syibhul Jumlah", indonesian: "Murid di dalam perpustakaan", correctWords: ["الطَّالِبُ", "فِي", "الْمَكْتَبَةِ"], distractors: ["عَلَى", "طَالِبٌ"] },
            { level: 2, category: "L2: Khobar Syibhul Jumlah", indonesian: "Mobil di depan rumah", correctWords: ["السَّيَّارَةُ", "أَمَامَ", "الْبَيْتِ"], distractors: ["وَرَاءَ", "بَيْتٌ"] },
            { level: 2, category: "L2: Khobar Syibhul Jumlah", indonesian: "Jam di atas dinding", correctWords: ["السَّاعَةُ", "عَلَى", "الْجِدَارِ"], distractors: ["فِي", "سَاعَةٌ"] },
            { level: 2, category: "L2: Khobar Syibhul Jumlah", indonesian: "Pakaian di dalam lemari", correctWords: ["الْمَلَابِسُ", "فِي", "الْخِزَانَةِ"], distractors: ["عَلَى", "خِزَانَةٌ"] },
            { level: 2, category: "L2: Khobar Syibhul Jumlah", indonesian: "Ikan di dalam air", correctWords: ["السَّمَكُ", "فِي", "الْمَاءِ"], distractors: ["عَلَى", "مَاءٌ"] },
            { level: 2, category: "L2: Khobar Syibhul Jumlah", indonesian: "Piring di atas meja", correctWords: ["الصَّحْنُ", "عَلَى", "الْمَكْتَبِ"], distractors: ["فِي", "صَحْنٌ"] },
            { level: 2, category: "L2: Khobar Syibhul Jumlah", indonesian: "Pena di dalam kotak", correctWords: ["الْقَلَمُ", "فِي", "الْعُلْبَةِ"], distractors: ["عَلَى", "عُلْبَةٌ"] },
            { level: 2, category: "L2: Syibhul Jumlah", indonesian: "Hadits dari Abu Hurairah", correctWords: ["الْحَدِيثُ", "عَنْ", "أَبِي", "هُرَيْرَةَ"], distractors: ["فِي", "أَبَا"] },
            { level: 2, category: "L2: Khobar Syibhul Jumlah", indonesian: "Guru (lk) di depan kelas", correctWords: ["الْمُدَرِّسُ", "أَمَامَ", "الْفَصْلِ"], distractors: ["وَرَاءَ", "فَصْلٌ"] },
            { level: 2, category: "L2: Khobar Syibhul Jumlah", indonesian: "Burung di atas pohon", correctWords: ["الطَّائِرُ", "فَوْقَ", "الشَّجَرَةِ"], distractors: ["تَحْتَ", "شَجَرَةٌ"] },
            
            // HIKMAH
            { level: 2, category: "L2: Kalimat Hikmah", indonesian: "Sholat itu cahaya", correctWords: ["الصَّلَاةُ", "نُورٌ"], distractors: ["صَلَاةٌ", "نُورًا"] },
            { level: 2, category: "L2: Kalimat Hikmah", indonesian: "Kebersihan itu sebagian dari iman", correctWords: ["النَّظَافَةُ", "مِنَ", "الْإِيمَانِ"], distractors: ["نَظَافَةٌ", "إِيمَانٌ"] },
            { level: 2, category: "L2: Kalimat Hikmah", indonesian: "Segala puji bagi Allah", correctWords: ["الْحَمْدُ", "لِلَّهِ"], distractors: ["لِ", "اللهِ"] },
            { level: 2, category: "L2: Kalimat Hikmah", indonesian: "Mukmin itu seperti bangunan", correctWords: ["الْمُؤْمِنُ", "كَالْبُنْيَانِ"], distractors: ["كَ", "بُنْيَانٌ"] },
            { level: 2, category: "L2: Kalimat Hikmah", indonesian: "Surga itu benar (nyata)", correctWords: ["الْجَنَّةُ", "حَقٌّ"], distractors: ["بَاطِلٌ", "جَنَّةٌ"] },
            { level: 2, category: "L2: Kalimat Hikmah", indonesian: "Neraka itu benar (nyata)", correctWords: ["النَّارُ", "حَقٌّ"], distractors: ["بَاطِلٌ", "نَارٌ"] },


            // =================================================================
            // LEVEL 3: JUMLAH FI'LIYAH (Fi'il + Fa'il)
            // =================================================================
            
            // -- Fi'il Madhi (Telah) --
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Zaid telah pergi", correctWords: ["ذَهَبَ", "زَيْدٌ"], distractors: ["يَذْهَبُ", "زَيْدًا"] }, 
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Anak (lk) itu telah tidur", correctWords: ["نَامَ", "الْوَلَدُ"], distractors: ["يَنَامُ", "وَلَدًا"] }, 
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Ahmad telah minum", correctWords: ["شَرِبَ", "أَحْمَدُ"], distractors: ["يَشْرَبُ", "أَحْمَدَ"] }, 
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Hamid telah masuk", correctWords: ["دَخَلَ", "حَامِدٌ"], distractors: ["يَدْخُلُ", "خَرَجَ"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Tamu itu telah datang", correctWords: ["جَاءَ", "الضَّيْفُ"], distractors: ["يَجِيءُ", "ضَيْفًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Anak (lk) itu telah duduk", correctWords: ["جَلَسَ", "الْوَلَدُ"], distractors: ["يَجْلِسُ", "وَلَدٌ"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Orang kafir itu telah ingkar", correctWords: ["كَفَرَ", "الْكَافِرُ"], distractors: ["يَكْفُرُ", "كَافِرًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Bayi itu telah tertawa", correctWords: ["ضَحِكَ", "الطِّفْلُ"], distractors: ["يَضْحَكُ", "طِفْلًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Bapak telah sakit", correctWords: ["مَرِضَ", "الْأَبُ"], distractors: ["يَمْرَضُ", "أَبٌ"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Anak-anak telah bermain", correctWords: ["لَعِبَ", "الْأَوْلَادُ"], distractors: ["يَلْعَبُ", "أَوْلَادًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Zaid telah tinggal (menetap)", correctWords: ["سَكَنَ", "زَيْدٌ"], distractors: ["يَسْكُنُ", "زَيْدًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Ibu telah memberi izin", correctWords: ["أَذِنَتْ", "الْأُمُّ"], distractors: ["تَأْذَنُ", "أُمًّا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Guru (lk) telah berdiri", correctWords: ["قَامَ", "الْمُدَرِّسُ"], distractors: ["يَقُومُ", "مُدَرِّسًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Siswa telah lulus (berhasil)", correctWords: ["نَجَحَ", "الطَّالِبُ"], distractors: ["يَنْجَحُ", "طَالِبًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Orang muslim telah ruku'", correctWords: ["رَكَعَ", "الْمُسْلِمُ"], distractors: ["يَرْكَعُ", "مُسْلِمًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Fatimah telah makan", correctWords: ["أَكَلَتْ", "فَاطِمَةُ"], distractors: ["تَأْكُلُ", "فَاطِمَةَ"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Ayah telah mandi", correctWords: ["اِسْتَحَمَّ", "الْأَبُ"], distractors: ["يَسْتَحِمُّ", "أَبًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Murid (lk) telah bertanya", correctWords: ["سَأَلَ", "الطَّالِبُ"], distractors: ["يَسْأَلُ", "طَالِبًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Guru (lk) telah mengetahui", correctWords: ["عَرَفَ", "الْمُدَرِّسُ"], distractors: ["يَعْرِفُ", "مُدَرِّسًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Umar telah pulang", correctWords: ["رَجَعَ", "عُمَرُ"], distractors: ["يَرْجِعُ", "عُمَرًا"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Aisyah telah keluar", correctWords: ["خَرَجَتْ", "عَائِشَةُ"], distractors: ["تَخْرُجُ", "عَائِشَةَ"] },
            { level: 3, category: "L3: Fi'il Madhi", indonesian: "Ali telah bersujud", correctWords: ["سَجَدَ", "عَلِيٌّ"], distractors: ["يَسْجُدُ", "عَلِيًّا"] },

            // -- Fi'il Mudhari (Sedang) --
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Fatimah sedang menulis", correctWords: ["تَكْتُبُ", "فَاطِمَةُ"], distractors: ["كَتَبَتْ", "فَاطِمَةَ"] }, 
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Aisyah sedang membaca", correctWords: ["تَقْرَأُ", "عَائِشَةُ"], distractors: ["قَرَأَتْ", "عَائِشَةَ"] }, 
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Zaid sedang berdiri", correctWords: ["يَقُومُ", "زَيْدٌ"], distractors: ["قَامَ", "زَيْدًا"] }, 
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Pegawai itu sedang keluar", correctWords: ["يَخْرُجُ", "الْمُوَظَّفُ"], distractors: ["خَرَجَ", "مُوَظَّفٌ"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Guru (lk) itu sedang menjawab", correctWords: ["يُجِيبُ", "الْمُدَرِّسُ"], distractors: ["أَجَابَ", "مُدَرِّسًا"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Anak (lk) itu sedang menangis", correctWords: ["يَبْكِي", "الْوَلَدُ"], distractors: ["بَكَى", "وَلَدًا"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Siswa itu sedang belajar", correctWords: ["يَدْرُسُ", "الطَّالِبُ"], distractors: ["دَرَسَ", "طَالِبٌ"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Orang muslim sedang berpuasa", correctWords: ["يَصُومُ", "الْمُسْلِمُ"], distractors: ["صَامَ", "مُسْلِمًا"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Ayah sedang bersafar", correctWords: ["يُسَافِرُ", "الْأَبُ"], distractors: ["سَافَرَ", "أَبًا"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Ibu sedang mencuci", correctWords: ["تَغْسِلُ", "الْأُمُّ"], distractors: ["غَسَلَتْ", "أُمًّا"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Fatimah sedang menyeterika", correctWords: ["تَكْوِي", "فَاطِمَةُ"], distractors: ["كَوَتْ", "فَاطِمَةَ"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Anak (lk) sedang mandi", correctWords: ["يَسْتَحِمُّ", "الْوَلَدُ"], distractors: ["اِسْتَحَمَّ", "وَلَدًا"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Pemain sedang berlari", correctWords: ["يَجْرِي", "اللَّاعِبُ"], distractors: ["جَرَى", "لَاعِبًا"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Orang muslim sedang sujud", correctWords: ["يَسْجُدُ", "الْمُسْلِمُ"], distractors: ["سَجَدَ", "مُسْلِمًا"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Dokter sedang memeriksa", correctWords: ["يَفْحَصُ", "الطَّبِيبُ"], distractors: ["فَحَصَ", "طَبِيبًا"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Petani sedang menanam", correctWords: ["يَزْرَعُ", "الْفَلَّاحُ"], distractors: ["زَرَعَ", "فَلَّاحًا"] },
            { level: 3, category: "L3: Fi'il Mudhari", indonesian: "Pedagang sedang menjual", correctWords: ["يَبِيعُ", "التَّاجِرُ"], distractors: ["بَاعَ", "تَاجِرًا"] },

            // =================================================================
            // LEVEL 4: MAHIR (SPOK / KOMPLEKS / ALTERNATIF JAWABAN)
            // =================================================================
            
            // -- Objek Nakirah/Ma'rifah dengan Alternatif Jawaban --
            { 
                level: 4, 
                category: "L4: Kalimat Lengkap", 
                indonesian: "Ibu sedang mencuci piring kotor", 
                correctWords: ["تَغْسِلُ", "الْأُمُّ", "الصَّحْنَ", "الْوَسِخَ"], 
                distractors: ["صَحْنًا", "وَسِخًا"], 
                alternatives: [["تَغْسِلُ", "الْأُمُّ", "صَحْنًا", "وَسِخًا"]] 
            },
            { 
                level: 4, 
                category: "L4: Kalimat Lengkap", 
                indonesian: "Ibu sedang memasak makanan", 
                correctWords: ["تَطْبُخُ", "الْأُمُّ", "الطَّعَامَ"], 
                distractors: ["طَعَامًا", "طَبَخَتْ"],
                alternatives: [["تَطْبُخُ", "الْأُمُّ", "طَعَامًا"]] 
            },
            { 
                level: 4, 
                category: "L4: Kalimat Lengkap", 
                indonesian: "Saya sedang membaca buku", 
                correctWords: ["أَقْرَأُ", "الْكِتَابَ"], 
                distractors: ["كِتَابًا", "قَرَأْتُ"],
                alternatives: [["أَقْرَأُ", "كِتَابًا"]] 
            },
            { 
                level: 4, 
                category: "L4: Kalimat Lengkap", 
                indonesian: "Zaid sedang meminum kopi panas", 
                correctWords: ["يَشْرَبُ", "زَيْدٌ", "الْقَهْوَةَ", "الْحَارَّةَ"], 
                distractors: ["قَهْوَةً", "حَارَّةً", "شَرِبَ"],
                alternatives: [["يَشْرَبُ", "زَيْدٌ", "قَهْوَةً", "حَارَّةً"]] 
            },
            { 
                level: 4, 
                category: "L4: Kalimat Lengkap", 
                indonesian: "Pedagang sedang menjual kemeja baru", 
                correctWords: ["يَبِيعُ", "التَّاجِرُ", "الْقَمِيصَ", "الْجَدِيدَ"], 
                distractors: ["قَمِيصًا", "جَدِيدًا", "بَاعَ"],
                alternatives: [["يَبِيعُ", "التَّاجِرُ", "قَمِيصًا", "جَدِيدًا"]] 
            },
            { 
                level: 4, 
                category: "L4: Kalimat Lengkap", 
                indonesian: "Ayah sedang membeli mobil", 
                correctWords: ["يَشْتَرِي", "الْأَبُ", "السَّيَّارَةَ"], 
                distractors: ["سَيَّارَةً", "اِشْتَرَى"],
                alternatives: [["يَشْتَرِي", "الْأَبُ", "سَيَّارَةً"]] 
            },
            { 
                level: 4, 
                category: "L4: Kalimat Lengkap", 
                indonesian: "Hujan sedang turun dari langit", 
                correctWords: ["يَنْزِلُ", "الْمَطَرُ", "مِنَ", "السَّمَاءِ"], 
                distractors: ["سَمَاءٍ", "نَزَلَ"],
                alternatives: [["يَنْزِلُ", "الْمَطَرُ", "مِنْ", "سَمَاءٍ"]] 
            },
            { 
                level: 4, 
                category: "L4: Kalimat Lengkap", 
                indonesian: "Siswa sedang menulis pelajaran", 
                correctWords: ["يَكْتُبُ", "الطَّالِبُ", "الدَّرْسَ"], 
                distractors: ["دَرْسًا", "كَتَبَ"],
                alternatives: [["يَكْتُبُ", "الطَّالِبُ", "دَرْسًا"]] 
            },
            { 
                level: 4, 
                category: "L4: Kalimat Lengkap", 
                indonesian: "Siswa (lk) sedang meminjam buku", 
                correctWords: ["يَسْتَعِيرُ", "الطَّالِبُ", "الْكِتَابَ"], 
                distractors: ["اِسْتَعَارَ", "كِتَابًا"],
                alternatives: [["يَسْتَعِيرُ", "الطَّالِبُ", "كِتَابًا"]] 
            },
            { 
                level: 4, 
                category: "L4: Kalimat Lengkap", 
                indonesian: "Dokter sedang memeriksa orang sakit", 
                correctWords: ["يَفْحَصُ", "الطَّبِيبُ", "الْمَرِيضَ"], 
                distractors: ["مَرِيضًا", "فَحَصَ"],
                alternatives: [["يَفْحَصُ", "الطَّبِيبُ", "مَرِيضًا"]] 
            },

            // -- Soal Level 4 Standar (Tanpa Ambigu) --
            { level: 4, category: "L4: Objek Ma'rifah", indonesian: "Siswa sedang menghafal pelajaran itu", correctWords: ["يَحْفَظُ", "الطَّالِبُ", "الدَّرْسَ"], distractors: ["حَفِظَ", "الدَّرْسُ"] }, 
            { level: 4, category: "L4: Objek Ma'rifah", indonesian: "Kita sedang bersyukur kepada Allah", correctWords: ["نَشْكُرُ", "اللهَ"], distractors: ["شَكَرْنَا", "اللهُ"] }, 
            { level: 4, category: "L4: Objek Ma'rifah", indonesian: "Allah sedang memerintah sholat", correctWords: ["يَأْمُرُ", "اللهُ", "بِالصَّلَاةِ"], distractors: ["أَمَرَ", "صَلَاةً"] },
            { level: 4, category: "L4: Objek Ma'rifah", indonesian: "Siswa telah mengambil pena itu", correctWords: ["أَخَذَ", "الطَّالِبُ", "الْقَلَمَ"], distractors: ["يَأْخُذُ", "قَلَمًا"] },
            { level: 4, category: "L4: Huruf Jar (Bi)", indonesian: "Saya sedang menulis dengan pena", correctWords: ["أَكْتُبُ", "بِالْقَلَمِ"], distractors: ["كَتَبْتُ", "قَلَمًا"] },
            { level: 4, category: "L4: Huruf Jar (Bi)", indonesian: "Kita sedang pergi dengan mobil", correctWords: ["نَذْهَبُ", "بِالسَّيَّارَةِ"], distractors: ["ذَهَبْنَا", "سَيَّارَةً"] },
            { level: 4, category: "L4: Huruf Jar (Bi)", indonesian: "Zaid telah memukul anjing dengan batu", correctWords: ["ضَرَبَ", "زَيْدٌ", "الْكَلْبَ", "بِالْحَجَرِ"], distractors: ["يَضْرِبُ", "حَجَرًا"] },
            { level: 4, category: "L4: Huruf Jar (Li)", indonesian: "Buku ini milik Muhammad", correctWords: ["هَذَا", "الْكِتَابُ", "لِمُحَمَّدٍ"], distractors: ["لِ", "مُحَمَّدٌ"] },
            { level: 4, category: "L4: Huruf Jar (Ka)", indonesian: "Wajahmu seperti bulan", correctWords: ["وَجْهُكَ", "كَالْقَمَرِ"], distractors: ["كَ", "قَمَرٌ"] },
            { level: 4, category: "L4: 'Athof (Wa)", indonesian: "Langit dan Bumi", correctWords: ["السَّمَاءُ", "وَ", "الْأَرْضُ"], distractors: ["أَرْضًا", "فِي"] },
            { level: 4, category: "L4: 'Athof (Wa)", indonesian: "Allah sedang menghidupkan dan mematikan", correctWords: ["يُحْيِي", "اللهُ", "وَ", "يُمِيتُ"], distractors: ["أَحْيَا", "أَمَاتَ"] },
            { level: 4, category: "L4: 'Athof (Au)", indonesian: "Kamu mau teh atau kopi?", correctWords: ["تُرِيدُ", "شَايًا", "أَوْ", "قَهْوَةً"], distractors: ["شَايٌ", "قَهْوَةٌ"] },
            { level: 4, category: "L4: 'Athof (Tsumma)", indonesian: "Zaid telah datang kemudian Umar", correctWords: ["جَاءَ", "زَيْدٌ", "ثُمَّ", "عُمَرُ"], distractors: ["أَوْ", "عُمَرًا"] },
            { level: 4, category: "L4: 'Athof (Am)", indonesian: "Apakah kamu tidur atau bangun?", correctWords: ["أَنَائِمٌ", "أَنْتَ", "أَمْ", "مُسْتَيْقِظٌ"], distractors: ["أَوْ", "نَائِمًا"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Saya sedang sholat di masjid berjamaah", correctWords: ["أُصَلِّي", "فِي", "الْمَسْجِدِ", "جَمَاعَةً"], distractors: ["صَلَّيْتُ", "مُصَلَّى"] }, 
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Fatimah sedang menutup pintu rumah", correctWords: ["تُغْلِقُ", "فَاطِمَةُ", "بَابَ", "الْبَيْتِ"], distractors: ["أَغْلَقَتْ", "بَابًا"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Ayah sedang pulang dari kantor", correctWords: ["يَرْجِعُ", "الْأَبُ", "مِنَ", "الْمَكْتَبِ"], distractors: ["رَجَعَ", "إِلَى"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Petani telah pergi ke sawah pagi hari", correctWords: ["ذَهَبَ", "الْفَلَّاحُ", "إِلَى", "الْمَزْرَعَةِ", "صَبَاحًا"], distractors: ["يَذْهَبُ", "مَسَاءً"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Para siswa sedang membaca Al-Qur'an di kelas", correctWords: ["يَقْرَأُ", "الطُّلَّابُ", "الْقُرْآنَ", "فِي", "الْفَصْلِ"], distractors: ["قَرَأَ", "الْقُرْآنُ"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Siswa (lk) sedang duduk di atas kursi", correctWords: ["يَجْلِسُ", "الطَّالِبُ", "عَلَى", "الْكُرْسِيِّ"], distractors: ["جَلَسَ", "فِي"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Singa itu sedang tidur di hutan", correctWords: ["يَنَامُ", "الْأَسَدُ", "فِي", "الْغَابَةِ"], distractors: ["نَامَ", "أَسَدٌ"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Ibu sedang mencuci piring kotor", correctWords: ["تَغْسِلُ", "الْأُمُّ", "الصَّحْنَ", "الْوَسِخَ"], distractors: ["صَحْنًا", "وَسِخًا"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Guru (lk) sedang berdiri di depan kelas", correctWords: ["يَقُومُ", "الْمُدَرِّسُ", "أَمَامَ", "الْفَصْلِ"], distractors: ["قَامَ", "وَرَاءَ"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Hujan sedang turun dari langit", correctWords: ["يَنْزِلُ", "الْمَطَرُ", "مِنَ", "السَّمَاءِ"], distractors: ["نَزَلَ", "سَمَاءٍ"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Zaid sedang menginginkan air", correctWords: ["يُرِيدُ", "زَيْدٌ", "الْمَاءَ"], distractors: ["أَرَادَ", "مَاءً"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Siswa telah meminjam buku dari perpustakaan", correctWords: ["اِسْتَعَارَ", "الطَّالِبُ", "الْكِتَابَ", "مِنَ", "الْمَكْتَبَةِ"], distractors: ["يَسْتَعِيرُ", "كِتَابًا"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Saya sedang membantu ibu di dapur", correctWords: ["أُسَاعِدُ", "الْأُمَّ", "فِي", "الْمَطْبَخِ"], distractors: ["سَاعَدْتُ", "أُمًّا"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Fatimah sedang menyeterika pakaian", correctWords: ["تَكْوِي", "فَاطِمَةُ", "الْمَلَابِسَ"], distractors: ["كَوَتْ", "مَلَابِسًا"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Anak itu sedang bermain bola", correctWords: ["يَلْعَبُ", "الْوَلَدُ", "الْكُرَةَ"], distractors: ["لَعِبَ", "كُرَةً"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Petani sedang menanam padi", correctWords: ["يَزْرَعُ", "الْفَلَّاحُ", "الرُّزَّ"], distractors: ["زَرَعَ", "رُزًّا"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Saya sedang memakan apel manis", correctWords: ["آكُلُ", "التُّفَّاحَ", "الْحُلْوَ"], distractors: ["أَكَلْتُ", "حُلْوًا"] },
            { level: 4, category: "L4: Kalimat Lengkap", indonesian: "Kucing sedang minum susu putih", correctWords: ["يَشْرَبُ", "الْقِطُّ", "اللَّبَنَ", "الْأَبْيَضَ"], distractors: ["شَرِبَ", "أَبْيَضَ"] }
        ];

        // --- UTILS & STORAGE ---
        const LEADERBOARD_KEY = 'tarkib_legend_leaderboard_v4'; // New Key for fresh start
        
        const getLeaderboard = () => {
            const stored = localStorage.getItem(LEADERBOARD_KEY);
            return stored ? JSON.parse(stored) : [];
        };

        const saveScoreToLeaderboard = (name, score, level) => {
            const current = getLeaderboard();
            const newEntry = { name, score, level, date: new Date().toLocaleDateString() };
            const updated = [...current, newEntry].sort((a, b) => b.score - a.score).slice(0, 50); 
            localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(updated));
        };

        const downloadCSV = () => {
            const scores = getLeaderboard();
            if (scores.length === 0) { alert("Belum ada data."); return; }
            let csvContent = "data:text/csv;charset=utf-8,No,Nama,Level,Skor,Tanggal\n"; 
            scores.forEach((row, i) => csvContent += `${i + 1},"${row.name}",${row.level},${row.score},${row.date}\n`);
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "tarkib_legend_scores.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        // --- COMPONENTS ---

        const Leaderboard = ({ onClose }) => {
            const scores = getLeaderboard();
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in" onPointerDown={(e) => e.stopPropagation()}>
                    <div className="bg-white rounded-3xl max-w-md w-full p-6 shadow-2xl pop-in relative overflow-hidden flex flex-col max-h-[80vh]">
                        <div className="absolute top-0 left-0 w-full h-20 bg-gradient-to-b from-yellow-100 to-white -z-10"></div>
                        <h2 className="text-3xl font-bold text-center text-yellow-600 mb-2 flex items-center justify-center gap-2"><span>🏆</span> Papan Skor</h2>
                        <div className="flex-grow overflow-y-auto scrollbar-hide mb-4 border rounded-xl bg-gray-50">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-gray-100 text-gray-600 text-sm uppercase sticky top-0 shadow-sm">
                                    <tr><th className="p-3">#</th><th className="p-3">Nama</th><th className="p-3">Lvl</th><th className="p-3 text-right">Skor</th></tr>
                                </thead>
                                <tbody>
                                    {scores.length === 0 ? (<tr><td colSpan="4" className="p-6 text-center text-gray-400 italic">Belum ada data</td></tr>) : (
                                        scores.map((entry, idx) => (
                                            <tr key={idx} className={`border-b last:border-0 ${idx < 3 ? 'bg-yellow-50/50' : ''}`}>
                                                <td className="p-3 font-bold text-gray-500">{idx+1}</td>
                                                <td className="p-3 font-bold text-gray-800">{entry.name}</td>
                                                <td className="p-3 text-sm text-gray-500">{entry.level}</td>
                                                <td className="p-3 text-right font-mono font-bold text-emerald-600">{entry.score}</td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                        <div className="flex flex-col gap-2">
                            <button onPointerDown={(e) => { e.preventDefault(); downloadCSV(); }} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition">📥 Download Laporan (Excel)</button>
                            <button onPointerDown={(e) => { e.preventDefault(); onClose(); }} className="w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-black transition">Tutup</button>
                        </div>
                    </div>
                </div>
            );
        };

        const NameInput = ({ mode, onNext, onCancel }) => {
            const [p1Name, setP1Name] = React.useState("");
            const [p2Name, setP2Name] = React.useState("");
            const handleSubmit = (e) => {
                e.preventDefault();
                if (mode === 'single' && p1Name.trim()) onNext(p1Name, null);
                else if (mode === 'duel' && p1Name.trim() && p2Name.trim()) onNext(p1Name, p2Name);
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in" onPointerDown={(e) => e.stopPropagation()}>
                    <div className="bg-white rounded-3xl max-w-md w-full p-8 shadow-2xl pop-in">
                        <h2 className="text-2xl font-bold text-emerald-800 mb-2 text-center">Siapa yang main?</h2>
                        <form onSubmit={handleSubmit} className="space-y-4 mt-4">
                            <div><label className="block text-sm font-bold text-gray-700 mb-1">Nama Player 1 {mode === 'duel' && '(Kiri)'}</label><input type="text" value={p1Name} onChange={(e) => setP1Name(e.target.value)} className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-emerald-500 focus:outline-none" placeholder="Tulis nama..." maxLength="12" autoFocus /></div>
                            {mode === 'duel' && (<div><label className="block text-sm font-bold text-gray-700 mb-1">Nama Player 2 (Kanan)</label><input type="text" value={p2Name} onChange={(e) => setP2Name(e.target.value)} className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-orange-500 focus:outline-none" placeholder="Tulis nama..." maxLength="12" /></div>)}
                            <div className="pt-4 flex gap-3"><button type="button" onPointerDown={(e) => {e.preventDefault(); onCancel();}} className="flex-1 bg-gray-100 text-gray-600 font-bold py-3 rounded-xl hover:bg-gray-200">Batal</button><button type="submit" onPointerDown={(e) => {if((!p1Name || (mode === 'duel' && !p2Name))) return; e.preventDefault(); handleSubmit(e);}} disabled={!p1Name || (mode === 'duel' && !p2Name)} className="flex-1 bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 disabled:opacity-50">Lanjut Pilih Level</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const LevelSelect = ({ onSelectLevel, onBack }) => {
            const levels = [
                { id: 1.1, title: "Level 1A", subtitle: "Jar Majrur & Zharaf", desc: "Contoh: Di atas meja, Di depan kelas" },
                { id: 1.2, title: "Level 1B", subtitle: "Idhafah (Sandaran)", desc: "Contoh: Pintu masjid, Kitab Allah" },
                { id: 1.3, title: "Level 1C", subtitle: "Na'at Man'ut (Sifat)", desc: "Contoh: Buku baru, Rumah besar" },
                { id: 2, title: "Level 2", subtitle: "Jumlah Ismiyah", desc: "Mubtada & Khobar" },
                { id: 3, title: "Level 3", subtitle: "Jumlah Fi'liyah", desc: "Fi'il Madhi & Mudhari" },
                { id: 4, title: "Level 4", subtitle: "Mahir", desc: "Kalimat Kompleks & SPOK" }
            ];
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-fade-in" onPointerDown={(e) => e.stopPropagation()}>
                    <div className="bg-white rounded-3xl max-w-lg w-full p-6 shadow-2xl pop-in">
                        <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold text-emerald-800">Pilih Tingkatan</h2><button onPointerDown={(e) => {e.preventDefault(); onBack();}} className="text-gray-400 hover:text-red-500 font-bold w-10 h-10 flex items-center justify-center">✕</button></div>
                        <div className="grid grid-cols-1 gap-3">
                            {levels.map((lvl) => (
                                <button key={lvl.id} onPointerDown={(e) => { e.preventDefault(); onSelectLevel(lvl.id); }} className="flex items-center p-4 rounded-xl border-2 border-emerald-100 hover:border-emerald-500 hover:bg-emerald-50 transition group text-left w-full">
                                    <div className="bg-emerald-100 text-emerald-600 font-bold w-12 h-12 rounded-full flex items-center justify-center text-xl group-hover:bg-emerald-500 group-hover:text-white transition">{Math.floor(lvl.id)}</div>
                                    <div className="ml-4"><h3 className="font-bold text-gray-800 text-lg">{lvl.title}: {lvl.subtitle}</h3><p className="text-sm text-gray-500">{lvl.desc}</p></div>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const MainMenu = ({ onModeSelect, onShowRules, onShowLeaderboard }) => (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden bg-emerald-50">
                <div className="absolute inset-0 bg-pattern"></div>
                <div className="z-10 w-full max-w-md bg-white/90 backdrop-blur-sm p-8 rounded-3xl shadow-2xl border-4 border-emerald-100 text-center pop-in">
                    <div className="mb-6 flex justify-center">
                        <img src="logo.png" alt="Logo Sekolah" className="h-28 w-auto object-contain" onError={(e) => { e.target.onerror = null; e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }} />
                        <div style={{display: 'none'}} className="text-6xl">🕌</div>
                    </div>
                    <h1 className="text-4xl font-extrabold text-emerald-800 mb-2 font-serif tracking-wide">TARKIB LEGEND</h1>
                    <p className="text-emerald-600 font-semibold mb-8">Game Edukasi Bahasa Arab</p>
                    <div className="space-y-3">
                        <button onPointerDown={(e) => {e.preventDefault(); onModeSelect('single');}} className="w-full bg-emerald-600 hover:bg-emerald-700 text-white text-xl font-bold py-4 rounded-2xl shadow-lg transition transform hover:scale-105 flex items-center justify-center gap-3"><span>👤</span> 1 Pemain</button>
                        <button onPointerDown={(e) => {e.preventDefault(); onModeSelect('duel');}} className="w-full bg-orange-500 hover:bg-orange-600 text-white text-xl font-bold py-4 rounded-2xl shadow-lg transition transform hover:scale-105 flex items-center justify-center gap-3"><span>⚔️</span> Duel 2 Pemain</button>
                        <div className="flex gap-3">
                            <button onPointerDown={(e) => {e.preventDefault(); onShowLeaderboard();}} className="flex-1 bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-3 rounded-2xl shadow-md transition transform hover:scale-105 flex items-center justify-center gap-2">🏆 Papan Skor</button>
                            <button onPointerDown={(e) => {e.preventDefault(); onShowRules();}} className="flex-1 bg-white hover:bg-gray-50 text-emerald-700 font-bold py-3 rounded-2xl border-2 border-emerald-200 shadow-sm transition">📜 Aturan</button>
                        </div>
                    </div>
                </div>
                <div className="mt-8 z-10 text-center"><p className="text-xs text-emerald-800 font-bold uppercase tracking-widest mb-1">Pengembang</p><div className="bg-white px-6 py-2 rounded-full shadow-sm border border-emerald-100"><p className="text-emerald-700 font-bold text-sm">SDIT Qurratu A'yun Al-Islami Maros</p></div></div>
            </div>
        );

        const RulesModal = ({ onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in" onPointerDown={(e) => e.stopPropagation()}>
                <div className="bg-white rounded-3xl max-w-md w-full p-6 shadow-2xl pop-in">
                    <h2 className="text-2xl font-bold text-emerald-800 mb-4 border-b pb-2">Aturan Permainan</h2>
                    <ul className="space-y-3 text-gray-700 mb-6 text-sm">
                        <li className="flex gap-2"><span className="text-emerald-500 font-bold">1.</span> Pilih Level yang ingin dimainkan.</li>
                        <li className="flex gap-2"><span className="text-emerald-500 font-bold">2.</span> Susun kata Arab sesuai terjemahan.</li>
                        <li className="flex gap-2"><span className="text-emerald-500 font-bold">3.</span> <span className="font-bold">Tantangan Waktu:</span> Soal pertama 60 detik, semakin lama semakin cepat.</li>
                        <li className="flex gap-2"><span className="text-emerald-500 font-bold">4.</span> Gunakan tombol "Papan Skor" untuk mendownload data nilai siswa.</li>
                    </ul>
                    <button onPointerDown={(e) => {e.preventDefault(); onClose();}} className="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700">Tutup</button>
                </div>
            </div>
        );

        const GameBoard = ({ isDuel = false, playerName = "Player", playerIndex = 1, questionData, questionIndex, onCorrect, onWrong, score }) => {
            const [availableWords, setAvailableWords] = React.useState([]);
            const [selectedWords, setSelectedWords] = React.useState([]);
            const [localState, setLocalState] = React.useState('playing');
            const [shake, setShake] = React.useState(false);
            const [wrongIndices, setWrongIndices] = React.useState([]);
            const [timeLeft, setTimeLeft] = React.useState(60);

            const calculateInitialTime = (idx) => (idx === 0 ? 60 : idx === 1 ? 50 : 40);

            React.useEffect(() => {
                if(questionData) {
                    const allWords = [
                        ...questionData.correctWords.map((w, i) => ({ id: `c-${i}`, text: w })),
                        ...questionData.distractors.map((w, i) => ({ id: `d-${i}`, text: w }))
                    ];
                    setAvailableWords(shuffleArray(allWords));
                    setSelectedWords([]);
                    setLocalState('playing');
                    setWrongIndices([]);
                    setTimeLeft(calculateInitialTime(questionIndex)); 
                }
            }, [questionData, questionIndex]);

            React.useEffect(() => {
                let timer;
                if (localState === 'playing' && timeLeft > 0) {
                    timer = setInterval(() => { setTimeLeft((prev) => prev - 1); }, 1000);
                } else if (timeLeft === 0 && localState === 'playing') {
                    handleWrongLogic();
                }
                return () => clearInterval(timer);
            }, [timeLeft, localState]);

            const handleWrongLogic = () => {
                playWrongSound();
                setLocalState('wrong');
                setShake(true);
                setTimeout(() => setShake(false), 500);
                onWrong(); 
            };

            const handleWordClick = (e, word) => {
                e.preventDefault(); 
                if(localState === 'correct') return;
                setAvailableWords(prev => prev.filter(w => w.id !== word.id));
                setSelectedWords(prev => [...prev, word]); 
                setWrongIndices([]); 
            };

            const handleSelectedClick = (e, word) => {
                e.preventDefault(); 
                if(localState === 'correct') return;
                setSelectedWords(prev => prev.filter(w => w.id !== word.id));
                setAvailableWords(prev => [...prev, word]);
                setLocalState('playing');
                setWrongIndices([]); 
            };

            const checkAnswer = (e) => {
                e.preventDefault(); 
                if(localState === 'correct') return;
                
                // --- LOGIKA KOREKSI JAWABAN (UTAMA + ALTERNATIF) ---
                const targets = [questionData.correctWords, ...(questionData.alternatives || [])];
                
                const isCorrect = targets.some(target => 
                    selectedWords.length === target.length &&
                    selectedWords.every((w, i) => w.text === target[i])
                );

                if (isCorrect) {
                    playCorrectSound();
                    setLocalState('correct');
                    onCorrect();
                } else {
                    playWrongSound();
                    setLocalState('wrong');
                    setShake(true);
                    setTimeout(() => setShake(false), 500);

                    if (!isDuel) {
                        let bestMatchIndices = [];
                        let minMismatchCount = Infinity;

                        targets.forEach(target => {
                            let mismatches = [];
                            selectedWords.forEach((w, i) => {
                                if (!target[i] || w.text !== target[i]) {
                                    mismatches.push(i);
                                }
                            });
                            if (mismatches.length < minMismatchCount) {
                                minMismatchCount = mismatches.length;
                                bestMatchIndices = mismatches;
                            }
                        });
                        setWrongIndices(bestMatchIndices);
                    }
                    onWrong();
                }
            };

            const borderColor = playerIndex === 2 ? 'border-orange-500' : 'border-emerald-500';
            const dynamicAnswerFont = selectedWords.length > 4 ? 'text-2xl md:text-3xl' : 'text-3xl md:text-5xl';

            return (
                <div className={`flex flex-col h-full bg-white border-b-8 ${isDuel ? borderColor : 'border-emerald-500'} relative`}>
                    <div className="bg-gray-100 p-2 flex justify-between items-center px-4 border-b border-gray-200 select-none">
                        <div className="flex flex-col max-w-[30%]"><span className={`text-xs font-bold uppercase truncate ${playerIndex === 2 ? 'text-orange-600' : 'text-emerald-600'}`}>{playerName}</span><span className="text-xs text-gray-400">Level {questionData.level} - Soal {questionIndex + 1}</span></div>
                        <div className={`flex items-center gap-1 font-bold ${timeLeft <= 10 ? 'text-red-600 pulse-red' : 'text-gray-700'}`}><span>⏱️ {timeLeft}</span></div>
                        <div className="bg-white px-2 py-1 rounded border border-gray-200"><span className="text-lg font-bold text-gray-800">⭐ {score}</span></div>
                    </div>
                    <div className="bg-emerald-50 p-4 text-center flex-grow flex items-center justify-center flex-col min-h-[100px] select-none">
                        <p className="text-gray-400 text-xs uppercase mb-1">{questionData.category}</p>
                        <h3 className="text-2xl md:text-3xl font-bold text-gray-800 leading-snug">"{questionData.indonesian}"</h3>
                    </div>
                    <div dir="rtl" className={`p-3 min-h-[120px] bg-white border-y border-gray-100 flex flex-wrap gap-2 justify-center items-center content-center transition-colors ${localState === 'wrong' ? 'bg-red-50' : ''}`}>
                        {selectedWords.length === 0 && <span className="text-sm text-gray-300 italic dir-ltr select-none">Susun kata di sini</span>}
                        {selectedWords.map((w, i) => {
                            const isWrong = wrongIndices.includes(i);
                            const btnStyle = isWrong ? "bg-red-100 border-red-500 text-red-600 animate-pulse" : "bg-white border-emerald-300 text-gray-800 hover:bg-red-50 hover:border-red-300";
                            return (
                                <button key={w.id} onPointerDown={(e) => handleSelectedClick(e, w)} className={`arabic-text ${dynamicAnswerFont} px-3 py-2 border-2 rounded-xl shadow-md transition-all ${btnStyle}`}>
                                    {w.text}
                                </button>
                            );
                        })}
                    </div>
                    <div className="p-4 bg-gray-50 flex flex-wrap gap-3 justify-center min-h-[120px] content-start overflow-y-auto">
                        {availableWords.map(w => (
                            <button key={w.id} onPointerDown={(e) => handleWordClick(e, w)} className="arabic-text text-2xl px-4 py-2 bg-white border border-gray-200 rounded-xl shadow-sm hover:bg-emerald-100 hover:border-emerald-300 hover:-translate-y-1 transition-all duration-200 text-emerald-800">
                                {w.text}
                            </button>
                        ))}
                    </div>
                    <div className="p-3">
                        {localState === 'correct' ? (
                            <div className="w-full bg-emerald-500 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 animate-pulse text-xl select-none"><span>✨ Mumtaz!</span></div>
                        ) : (
                            <button onPointerDown={checkAnswer} disabled={selectedWords.length === 0} className={`w-full font-bold py-4 rounded-xl shadow-md transition text-lg ${selectedWords.length === 0 ? 'bg-gray-200 text-gray-400' : 'bg-emerald-600 text-white active:scale-95 hover:bg-emerald-700'}`}>Cek Jawaban</button>
                        )}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = React.useState('menu'); 
            const [tempMode, setTempMode] = React.useState('single');
            const [selectedLevel, setSelectedLevel] = React.useState(null);
            
            const [sessionQuestions, setSessionQuestions] = React.useState([]);
            const [questionIdx, setQuestionIdx] = React.useState(0);

            const [p1Name, setP1Name] = React.useState("");
            const [p2Name, setP2Name] = React.useState("");

            const [spScore, setSpScore] = React.useState(0);
            const [spLives, setSpLives] = React.useState(3);
            const [spFinished, setSpFinished] = React.useState(false);

            const [p1Score, setP1Score] = React.useState(0);
            const [p2Score, setP2Score] = React.useState(0);
            const [duelRoundKey, setDuelRoundKey] = React.useState(0);

            const goHome = () => { setView('menu'); setSpFinished(false); }
            const goLevelSelect = () => { setSpFinished(false); setView('levelSelect'); }

            const handleModeSelect = (mode) => { setTempMode(mode); setView('inputName'); };
            const handleNameSubmit = (name1, name2) => { setP1Name(name1); if(name2) setP2Name(name2); setView('levelSelect'); };

            const handleLevelSelect = (levelId) => {
                setSelectedLevel(levelId);
                const filtered = gameDataDatabase.filter(q => q.level === levelId);
                const shuffled = shuffleArray(filtered);
                // LIMIT SESSION TO 20 QUESTIONS MAX to ensure variety across plays
                const sessionSet = shuffled.slice(0, 20); 
                setSessionQuestions(sessionSet);
                setQuestionIdx(0);
                if (tempMode === 'single') { setSpScore(0); setSpLives(3); setSpFinished(false); setView('single'); } 
                else { setP1Score(0); setP2Score(0); setDuelRoundKey(0); setView('duel'); }
            };

            const handleSpCorrect = () => {
                setSpScore(s => s + 100);
                setTimeout(() => {
                    if (questionIdx + 1 < sessionQuestions.length) {
                        setQuestionIdx(p => p + 1);
                    } else {
                        setSpFinished(true);
                        saveScoreToLeaderboard(p1Name, spScore + 100, selectedLevel);
                        if(selectedLevel === 4) { playGrandFanfare(); fireConfetti(2); } else { playLevelCompleteSound(); fireConfetti(1); }
                    }
                }, 1500);
            };

            const handleSpWrong = () => {
                setSpLives(l => l - 1);
                if (spLives <= 1) {
                    setSpFinished(true);
                    playWrongSound();
                    saveScoreToLeaderboard(p1Name, spScore, selectedLevel);
                }
            };

            const handleDuelWin = (winner) => {
                if (document.duelLocked) return;
                document.duelLocked = true;
                if (winner === 1) setP1Score(s => s + 1); else setP2Score(s => s + 1);
                setTimeout(() => {
                    if (questionIdx + 1 < sessionQuestions.length) {
                        setQuestionIdx(p => p + 1);
                        setDuelRoundKey(k => k + 1);
                        document.duelLocked = false;
                    } else {
                        setSpFinished(true);
                        if(selectedLevel === 4) { playGrandFanfare(); fireConfetti(2); } else { playLevelCompleteSound(); fireConfetti(1); }
                    }
                }, 1500);
            };

            if (view === 'menu') return <MainMenu onModeSelect={handleModeSelect} onShowRules={() => setView('rules')} onShowLeaderboard={() => setView('leaderboard')} />;
            if (view === 'rules') return <RulesModal onClose={goHome} />;
            if (view === 'leaderboard') return <Leaderboard onClose={goHome} />;
            if (view === 'inputName') return <NameInput mode={tempMode} onNext={handleNameSubmit} onCancel={goHome} />;
            if (view === 'levelSelect') return <LevelSelect onSelectLevel={handleLevelSelect} onBack={() => setView('inputName')} />;

            if (spFinished) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-emerald-50 p-6">
                        <div className="bg-white p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full pop-in">
                            <h2 className="text-3xl font-bold text-emerald-800 mb-4">Permainan Selesai!</h2>
                            <p className="text-sm text-gray-500 mb-6">Level {selectedLevel}</p>
                            {view === 'duel' ? (
                                <div className="space-y-4 mb-8">
                                    <div className="flex gap-4 justify-center">
                                        <div className={`p-4 rounded-xl w-1/2 ${p1Score > p2Score ? 'bg-emerald-100 border-2 border-emerald-500' : 'bg-gray-100'}`}>
                                            <p className="font-bold text-gray-600 truncate">{p1Name}</p>
                                            <p className="text-4xl font-bold text-emerald-600">{p1Score}</p>
                                        </div>
                                        <div className={`p-4 rounded-xl w-1/2 ${p2Score > p1Score ? 'bg-orange-100 border-2 border-orange-500' : 'bg-gray-100'}`}>
                                            <p className="font-bold text-gray-600 truncate">{p2Name}</p>
                                            <p className="text-4xl font-bold text-orange-600">{p2Score}</p>
                                        </div>
                                    </div>
                                    <p className="text-xl font-bold mt-4">{p1Score === p2Score ? "Seri!" : (p1Score > p2Score ? `${p1Name} Menang!` : `${p2Name} Menang!`)}</p>
                                </div>
                            ) : (
                                <div className="mb-8">
                                    <p className="text-gray-500 font-bold mb-1">{p1Name}</p>
                                    <p className="text-sm text-gray-400 uppercase">Skor Akhir</p>
                                    <p className="text-6xl font-bold text-emerald-600 mb-2">{spScore}</p>
                                    <p className="text-sm text-yellow-600 bg-yellow-100 py-1 px-3 rounded-full inline-block">{spLives > 0 ? "🏆 Tamat Sempurna" : "Disimpan di Papan Skor"}</p>
                                </div>
                            )}
                            <div className="flex flex-col gap-3">
                                <button onPointerDown={(e) => {e.preventDefault(); goLevelSelect();}} className="w-full bg-emerald-600 text-white font-bold py-3 rounded-xl hover:bg-emerald-700 transition">📚 Pilih Level Lain</button>
                                <button onPointerDown={(e) => {e.preventDefault(); setView('leaderboard');}} className="w-full bg-yellow-500 text-white font-bold py-3 rounded-xl hover:bg-yellow-600 transition">🏆 Lihat Papan Skor</button>
                                <button onPointerDown={(e) => {e.preventDefault(); goHome();}} className="w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-black transition">🏠 Kembali ke Menu</button>
                            </div>
                        </div>
                    </div>
                );
            }

            const currentQ = sessionQuestions[questionIdx];
            if (!currentQ) return <div className="min-h-screen flex items-center justify-center">Loading...</div>;

            if (view === 'duel') {
                return (
                    <div className="h-screen w-screen flex overflow-hidden bg-gray-900" onPointerDown={(e) => e.stopPropagation()}>
                        <div className="w-1/2 h-full relative border-r-4 border-gray-700">
                            <GameBoard key={`p1-${duelRoundKey}`} isDuel={true} playerName={p1Name} playerIndex={1} questionData={currentQ} questionIndex={questionIdx} onCorrect={() => handleDuelWin(1)} onWrong={() => {}} score={p1Score} />
                        </div>
                        <div className="w-1/2 h-full relative">
                            <GameBoard key={`p2-${duelRoundKey}`} isDuel={true} playerName={p2Name} playerIndex={2} questionData={currentQ} questionIndex={questionIdx} onCorrect={() => handleDuelWin(2)} onWrong={() => {}} score={p2Score} />
                        </div>
                        <div className="absolute top-4 left-1/2 transform -translate-x-1/2 flex gap-2 z-50">
                            <button onPointerDown={(e) => {e.preventDefault(); goHome();}} className="bg-gray-800 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg border-2 border-white hover:bg-black" title="Menu Utama">🏠</button>
                            <button onPointerDown={(e) => {e.preventDefault(); goLevelSelect();}} className="bg-emerald-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg border-2 border-white hover:bg-emerald-700" title="Pilih Level">📚</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-emerald-50 flex flex-col max-w-md mx-auto shadow-2xl overflow-hidden relative" onPointerDown={(e) => e.stopPropagation()}>
                    <div className="bg-white p-4 flex justify-between items-center shadow-sm z-10">
                        <div className="flex gap-2">
                            <button onPointerDown={(e) => {e.preventDefault(); goHome();}} className="text-gray-400 hover:text-emerald-600 font-bold px-2 py-1 rounded hover:bg-emerald-50 border border-transparent hover:border-emerald-200 transition" title="Menu Utama">🏠</button>
                            <button onPointerDown={(e) => {e.preventDefault(); goLevelSelect();}} className="text-gray-400 hover:text-emerald-600 font-bold px-2 py-1 rounded hover:bg-emerald-50 border border-transparent hover:border-emerald-200 transition" title="Pilih Level">📚 Level</button>
                        </div>
                        <div className="flex gap-1">{[1,2,3].map(i => <span key={i} className={i <= spLives ? "text-red-500" : "text-gray-200"}>❤️</span>)}</div>
                    </div>
                    <div className="w-full bg-gray-200 h-2">
                        <div className="bg-emerald-500 h-2 transition-all" style={{width: `${((questionIdx)/sessionQuestions.length)*100}%`}}></div>
                    </div>
                    <div className="flex-grow relative bg-white">
                        <GameBoard key={`sp-${questionIdx}`} playerName={p1Name} playerIndex={1} questionData={currentQ} questionIndex={questionIdx} onCorrect={handleSpCorrect} onWrong={handleSpWrong} score={spScore} />
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
